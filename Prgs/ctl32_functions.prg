con=ODBC(5)
SQLEXEC(con,"select YEAR(getdate())*100+CAST(DATENAME( Wk,getdate()) as int)  zz","tmp3")
eend=zz+1
  IF  sqlexec(con,"SELECT TOP 10 TB003,TB012 品名,TB013 规格,"+;
  "SUM(TB004) AS  需用数量,SUM(TB005) AS  已领数量,"+;
	" 0000000 最新结存 ,0000000 配料中转,0000000  as 需采购数量,0000000 在途量, 0000000 请购未采购 ,"+;
	"0000000 调拨未完成,0000000  as 工单需要数,0000000 订单直接采购,INVMB.MB036 提前期,"+;
	"MV002 AS 采购员 FROM MOCTA MOCTA INNER JOIN MOCTB ON TA001=TB001 AND TA002=TB002 "+;
	" INNER JOIN INVMB ON TB003 = INVMB.MB001 inner JOIN CMSMV ON INVMB.MB067 = CMSMV.MV001 "+;
	"left JOIN INVMA CA ON CA.MA002=INVMB.MB006 AND CA.MA001='2' "+;
	" where CAST(LEFT(TB015,4) as int)*100+cast(DATENAME( Wk,CAST(TB015 AS DATETIME)) as int)<=?EEND and MOCTA.TA011<='3' AND TA013='Y' "+;
	" and  MOCTA.TA013='Y' AND CA.MA003<>'彩包'  AND INVMB.MB006<>'990050' "+;
	" AND MV002<>'鲁鹤明' GROUP BY TB003,TB012 ,TB013,MV002,INVMB.MB036" ,"TmpMakeBuy1")<0  
		WAIT WINDOWS 'ERROR'
		RETURN
*		" and not exists (select 'x' from PURTD WHERE MOCTA.TA033=TD024 AND TD004=TB003 AND TD018='Y') AND&&AND MOCTA.UDF56=1MOCTA.UDF03>=?FEND AND  "+;
*	" AND not exists (select 'x' from MOCTA T INNER JOIN INVMB M ON T.TA006=M.MB001 WHERE T.TA033=MOCTA.TA033 AND T.TA006=TB003 AND (MOCTB.TB004=MOCTB.TB005 OR T.TA015-T.TA017<=M.MB064)) "+;

	ENDIF

SQLEXEC(con,"SELECT TB004,SUM(TB007) TB007 FROM INVTB INNER JOIN INVTA ON TA001=TB001 AND TA002=TB002 WHERE  "+;
" TA006='N' AND (TB013='21' OR TB013='23') AND TB018='Y'  GROUP BY TB004","TMWP3") && LEFT(TA003 ,4)+'.'+DATENAME( Wk,CAST(TA003 AS DATETIME))>=?FEND AND AND LEFT(TA003 ,4)+'.'+DATENAME( Wk,CAST(TA003 AS DATETIME))<=?EEND

 SELECT TmpMakeBuy1

lcmsg = '正在整理订单需要的物料...'
 GO TOP
 DO WHILE  .NOT. EOF()
      SELECT TmpMakeBuy1
      a1 = ''
      keytxt = RTRIM(tb003)
		XX=0
		XX1=0
		SQLEXEC(con,"select SUM(TB004-TB005) SS FROM MOCTA INNER JOIN MOCTB ON TA001=TB001 AND TA002=TB002 WHERE TA011<='3' AND TB003=?keytxt AND TA013='Y' AND "+;
		"CAST(LEFT(TB015,4) as int)*100+cast(DATENAME( Wk,CAST(TB015 AS DATETIME)) as int)<=?EEND")
		IF RECCOUNT()=1 AND !ISNULL(SS)
			XX=SS
		ENDIF	

		SQLEXEC(con,"select SUM(A.TA015-A.TA017) SS FROM MOCTA A WHERE A.TA011<='3' AND A.TA006=?keytxt AND A.TA013='Y'  AND "+;
		"CAST(LEFT(A,TA009,4) as int)*100+cast(DATENAME( Wk,CAST(A.TA009 AS DATETIME)) as int)<=?EEND AND "+;
		"NOT EXISTS (SELECT 'X' FROM MOCTA A1  INNER JOIN MOCTB ON A1.TA001=TB001 AND A1.TA002=TB002 WHERE  TB003=A.TA006  AND A.TA033=A1.TA033)")

		IF RECCOUNT()=1 AND !ISNULL(SS)
			XX1=SS
		ENDIF	
		SELECT tmpmakebuy1
		REPLACE 需用数量 WITH XX+XX1
		CODE31ID1=0
	  	CODE31ID2=0

		SQLEXEC(con,"SELECT SUM(TB009) TD007 FROM PURTB WHERE TB004=?KEYTXT  AND TB021='N' AND TB025='Y' AND TB020='Y' AND "+;
		"CAST(LEFT(TB019,4) as int)*100+cast(DATENAME( Wk,CAST(TB019 AS DATETIME)) as int)<=?EEND","TMP3")  &&LEFT(TB019,4)+'.'+DATENAME( Wk,CAST(TB019 AS DATETIME))>=?FEND AND 
		IF RECCOUNT()=1  AND !ISNULL(TD007)
			IF ISNULL(TD007)
		  		CODE31ID1=0
		  	ELSE
		  		CODE31ID1=TD007
		  	ENDIF
		ELSE  	
	  		CODE31ID1=0
	  	ENDIF		
		SELECT tmpmakebuy1
		REPLACE 请购未采购 WITH	 CODE31ID1 	
		SQLEXEC(con,"SELECT SUM(TD008) TD007 FROM COPTD WHERE TD004=?KEYTXT  AND TD016='N' AND TD021='Y' AND "+;
		" LEFT(TD013,4)+'.'+DATENAME( Wk,CAST(TD013 AS DATETIME))<=?EEND","TMP3")  &&LEFT(TD013,4)+'.'+DATENAME( Wk,CAST(TD013 AS DATETIME))>=?FEND AND
		IF RECCOUNT()=1  AND !ISNULL(TD007)
			IF ISNULL(TD007)
		  		CODE31ID2=0
		  	ELSE
		  		CODE31ID2=TD007
		  	ENDIF
		ELSE  	
	  		CODE31ID2=0
	  	ENDIF		
		SELECT tmpmakebuy1
		REPLACE 订单直接采购 WITH	 CODE31ID2
		SELECT TMWP3
		LOCATE FOR TB004=KEYTXT
		IF FOUND()
			CODE2ID=TB007 
		ELSE
			CODE2ID=0
		ENDIF
		SELECT tmpmakebuy1
		REPLACE 工单需要数 WITH 需用数量,需用数量 WITH 需用数量+CODE2ID+订单直接采购,调拨未完成 WITH CODE2ID	
		IF SQLEXEC(CON,"SELECT SUM(PURTD.TD008-PURTD.TD015) as 在途量 FROM PURTD WHERE PURTD.TD016='N' AND PURTD.TD018='Y' AND PURTD.TD004=?KEYTXT ","TMP3")<0
			WAIT windows '????????'
		endif	
		MKEYID=0
		SELECT TMP3
		IF RECCOUNT()=1
			IF !ISNULL(在途量)
				MKEYID=在途量
			ENDIF
		ENDIF
		SQLEXEC(CON,"SELECT SUM(TA015-TA017+TA018) AS 在途量 FROM MOCTA WHERE TA030='2' AND TA006=?KEYTXT AND CAST(LEFT(TA010,4) as int)*100+cast(DATENAME( Wk,CAST(TA010 AS DATETIME)) as int)<=?EEND AND TA011<='3' ","TMP4")  && and UDF56=1
		IF !ISNULL(在途量)
			MKEYID=在途量+MKEYID
		ENDIF
				
		SELECT TmpMakeBuy1
		REPLACE 在途量 WITH MKEYID


	SQLEXEC(con,"SELECT MC007  FROM INVMC  WHERE MC002='50' AND MC001=?KEYTXT","TMP3")
	SELECT tmp3
	IF RECCOUNT()=1
		IF ISNULL(MC007)
	  		CODEID=0
	  	ELSE
		  	codeid=MC007
	  	ENDIF
		SELECT TmpMakeBuy1
		REPLACE 配料中转 WITH CODEID
		Closedb("TMP3")
	ELSE 
		SELECT TmpMakeBuy1
		REPLACE 配料中转 WITH 0
	ENDIF 

	SQLEXEC(con,"SELECT SUM(MC007) MC007 FROM INVMC WHERE MC001=?KEYTXT AND MC002<>'50' AND  MC002<>'19'  AND MC001<>'21'  AND MC001<>'22'","TMP3")
	SELECT tmp3
	IF RECCOUNT()=1
		IF ISNULL(MC007)
	  		CODEID=0
	  	ELSE
	  		codeid=MC007
	  	ENDIF
		SELECT TmpMakeBuy1
		REPLACE 最新结存 WITH CODEID
		Closedb("TMP3")
	ELSE 
		SELECT TmpMakeBuy1
		REPLACE 最新结存 WITH 0
	ENDIF 

	SELECT TmpMakeBuy1
	replace 需采购数量 WITH  需用数量-已领数量-最新结存-配料中转 &&-在途量

	SELECT TmpMakeBuy1
	skip
 ENDDO    
     
  closedb("TmpMakeBuyBY")

   	SELECT * FROM TmpMakeBuy1 WHERE 需采购数量>0 ORDER BY 9 desc INTO CURSOR TmpMakeBuyBY READWRITE 
	SELECT TmpMakeBuyBY
	TT=RECCOUNT()
	mtitle='第['+ALLTRIM(STR(eend))+']周之前净需求物料预警'
	m_note1='共有['+ALLTRIM(STR(TT))+']种货品缺料：'

	GO TOP
	s=''
	DO WHILE .NOT. EOF()
		KEYTXT=ALLT(TB003)
		SQLEXEC(CON,"SELECT distinct TA001+TA002 AS UDF55, convert(char(10),CAST(TA010,102) 要求交期,COPMA.MA002 AS 客户名称 "+;
		"FROM MOCTA INNER JOIN MOCTB ON TA001=TB001 and TA002=TB002 INNER JOIN  COPTC ON TA033=RTRIM(TC001)+TC002 "+;
		"  INNER JOIN COPMA ON TC004=COPMA.MA001 "+;
		"WHERE CAST(LEFT(TB015,4) as int)*100+cast(DATENAME( Wk,CAST(TB015 AS DATETIME)) as int)<=?EEND AND TA013='Y'  AND TB003=?KEYTXT AND TB004>TB005 AND MOCTA.TA011<='3' ORDER BY 2","TMP")  &&and MOCTA.UDF56=1
		FD=''
		SELECT TMP
		GO TOP
		DO WHILE .NOT. EOF()
			IF LEN(FD)<210
				FD=FD+ALLTRIM(STR(UDF55))+'('+ALLTRIM(要求交期)+')['+ALLTRIM(客户名称)+']；'
			ELSE
				FD=FD+'...'
				EXIT
			ENDIF	
			SKIP
		ENDDO
		i=i+1
		SELECT TmpMakeBuyBY
		REPLACE PI WITH FD
		S=ALLTRIM(STR(RECNO()))+'.'+ALLTRIM(品名)+'['+ALLTRIM(KEYTXT)+','+ALLTRIM(采购员)+']缺数:'+ALLTRIM(STR(需采购数量))+'='
		IF 工单需要数>0
			s=s+'+'+ALLTRIM(STR(工单需要数))+'(工单需数)'
		ENDIF 
		IF 订单直接采购>0
			s=s+'+'+ALLTRIM(STR(订单直接采购))+'(订单需数)'
		ENDIF 
		IF 调拨未完成>0
			s=s+'+'+ALLTRIM(STR(调拨未完成))+'(调拨)'
		ENDIF 
		IF 已领数量>0
			s=s+'-'+ALLTRIM(STR(已领数量))+'(已领数量)'
		ENDIF 
		IF 最新结存>0
			s=s+'-'+ALLTRIM(STR(最新结存))+'(主库库存)'
		ENDIF 
		IF 配料中转>0
			s=s+'-'+ALLTRIM(STR(配料中转))+'(中转库存)'
		ENDIF		
		IF 请购未采购>0
			s=s+'[请购未采购:'+ALLTRIM(STR(请购未采购))+']'
		ENDIF 
		s=s+'['+ALLTRIM(FD)+']'+CHR(13)+CHR(10)
		SKIP
	ENDDO	
  SQLDISCONNECT(CON)

	m_note=m_note1+s
	mrev='王亚萍;'
	IF USED("LHBC")
		SELECT LHBC
		USE
	ENDIF	
	SELECT DISTINCT 采购员 FROM TmpMakeBuy1 INTO CURSOR LHBC
	SELECT LHBC
	DO WHIL .NOT. EOF()
		SELECT LHBC
		IF ALLTRIM(采购员)<>'王亚萍'
			mrev=mrev+ALLTRIM(采购员)+';'
		ENDIF 	
		SKIP
	ENDDO	
	USE
	tmpkeyid=maxinterid("rtxmessage")
	keyidid1=ODBC(6)
	IF SQLEXEC(keyidid1,"insert rtxmessage (interid,toman,billname,creatdate,note,title,sysid) values (?tmpkeyid,?mrev,'鲁红斌',getdate(),?m_note,?mtitle,10)")<0
		WAIT windows '????' nowait
	ENDIF 
	SQLDISCONNECT(keyidid1)
